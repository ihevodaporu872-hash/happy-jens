# Контекст проекта: Telegram бот для тендерной документации

## Обзор

Telegram бот для генподрядной строительной компании. Позволяет работать с тендерной документацией через AI (Gemini). Каждый **store** = один тендер с загруженными документами (PDF, DOCX и т.д.).

**Стек:**
- Python 3.10+
- python-telegram-bot (async)
- Google Gemini API (File Search, генерация)
- Google Drive API (загрузка файлов)

---

## Архитектура

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   Telegram      │────▶│     bot.py       │────▶│  Gemini API     │
│   Пользователь  │◀────│   (основной)     │◀────│  File Search    │
└─────────────────┘     └──────────────────┘     └─────────────────┘
                               │
        ┌──────────────────────┼──────────────────────┐
        ▼                      ▼                      ▼
┌───────────────┐    ┌─────────────────┐    ┌────────────────┐
│ QueryProcessor│    │  GeminiClient   │    │    Router      │
│ (понимание)   │    │ (File Search)   │    │ (маршрутизация)│
└───────────────┘    └─────────────────┘    └────────────────┘
        │                      │
        ▼                      ▼
┌───────────────┐    ┌─────────────────┐
│MemoryClient   │    │  ExportClient   │
│ (история)     │    │  (PDF/DOCX)     │
└───────────────┘    └─────────────────┘
```

---

## Файлы проекта

| Файл | Описание |
|------|----------|
| `bot.py` | Главный файл. Telegram handlers, команды, интеграция всех компонентов |
| `gemini_client.py` | Работа с Gemini File Search API: stores, документы, запросы |
| `query_processor.py` | AI-понимание запросов пользователя (Gemini Pro) |
| `router.py` | Маршрутизация вопросов к нужным stores (Gemini Flash) |
| `memory_client.py` | Память пользователя (5 сообщений на store) |
| `export_client.py` | Экспорт ответов в PDF/DOCX |
| `google_drive_client.py` | Загрузка файлов из Google Drive |
| `config.py` | Конфигурация (токены, пути, настройки) |
| `stores.json` | Метаданные stores (id, name, description, documents) |
| `user_memory.json` | История диалогов пользователей |

---

## Модели Gemini

### Стратегия выбора модели (цена/качество)

| Модель | ID | Когда использовать |
|--------|----|--------------------|
| **Gemini 3 Pro** | `gemini-3-pro-preview` | Сложные задачи: анализ намерений, сравнение stores, генерация описаний |
| **Gemini 3 Flash** | `gemini-3-flash-preview` | Простые/средние задачи: прямые запросы, поиск фактов, роутинг |

### Распределение по задачам

| Компонент/Задача | Модель | Причина |
|------------------|--------|---------|
| `QueryProcessor` | Pro | Понимание намерений с ошибками/опечатками |
| `compare_stores()` | Pro | Глубокий анализ двух источников |
| `analyze_store_content()` | Pro | Генерация названия/описания store |
| Сложные запросы (complexity="complex") | Pro | Аналитика, синтез |
| Простые/средние запросы | Flash | Быстро, достаточно качества |
| Мультистор поиск | Flash | Параллельный поиск фактов |
| Веб-поиск (grounding) | Flash | Не требует глубокого анализа |
| Роутинг | Flash | Простая классификация |
| Транскрипция голоса | Flash | Прямое преобразование |
| Распознавание изображений | Flash | Прямое описание |

---

## Фичи бота

### 1. Мультистор запросы
- **Триггер:** AI автоматически определяет (QueryProcessor)
- **Пример:** "В каких тендерах есть водопонижение?"
- **Результат:** Список stores с краткими цитатами

### 2. Сравнение stores
- **Команда:** `/compare <store1> <store2> <тема>`
- **Пример:** `/compare МайПриорити Дубровка земляные работы`
- **Результат:** Сравнительный анализ по теме

### 3. Цитирование источников
- **Триггер:** AI определяет запрос источника ("откуда информация?")
- **Результат:** Ответ + ссылки на Google Docs

### 4. Автообновление stores
- **Настройка:** `/setsync <store> <url1> [url2]`
- **Принудительно:** `/syncnow [store]`
- **Автоматически:** Каждые 24 часа (JobQueue)

### 5. Экспорт ответов
- **Команда:** `/export [вопрос]`
- **Кнопки:** [PDF] [DOCX] под ответом
- **Результат:** Файл в Telegram

### 6. Веб-поиск
- **Триггер:** AI определяет ("актуальные цены", "текущие нормы")
- **Технология:** Gemini grounding (Google Search)

### 7. Память пользователя
- **Хранит:** 5 последних сообщений на user+store
- **Очистка:** `/clear`
- **Автоочистка:** Раз в неделю (старше 7 дней)

### 8. Авто-создание store из папки
- **Триггер:** Отправить ссылку на папку Google Drive
- **Результат:** Создаёт store, загружает файлы, AI генерирует название и описание

---

## Команды бота

| Команда | Описание | Доступ |
|---------|----------|--------|
| `/start` | Приветствие | Все |
| `/help` | Справка | Все |
| `/stores` | Список доступных stores | Все |
| `/select <name>` | Выбрать store для вопросов | Все |
| `/clear` | Очистить историю диалога | Все |
| `/compare <s1> <s2> <тема>` | Сравнить два store | Все |
| `/export [вопрос]` | Экспорт в PDF/DOCX | Все |
| `/addstore` | Создать новый store | Админ |
| `/deletestore <name>` | Удалить store | Админ |
| `/upload <store>` | Загрузить документ в store | Админ |
| `/uploadurl <store> <url>` | Загрузить из Google Drive | Админ |
| `/setsync <store> <urls>` | Настроить автосинхронизацию | Админ |
| `/syncnow [store]` | Принудительная синхронизация | Админ |

---

## QueryProcessor - AI понимание запросов

Центральный компонент для понимания намерений пользователя.

### Что определяет:
- **query_type:** single, multistore, web_search, compare, sources
- **complexity:** simple, medium, complex (для выбора модели)
- **optimized_prompt:** Улучшенный запрос для store
- **user_intent:** Что хочет пользователь
- **confidence:** Уверенность в интерпретации (0-1)

### Обрабатывает:
- Опечатки: "водопанижение" → "водопонижение"
- Транслит: "майприорити" → "MYPRIORITY"
- Неполные вопросы с учётом контекста
- Смешанные языки (русский/английский)

### Пример работы:
```
Вход: "в майприорити есть инфа про водопанижение?"
↓
QueryProcessor анализирует с Gemini Pro
↓
Выход:
- query_type: "single"
- target_store: "MYPRIORITY"
- optimized_prompt: "Какая информация о водопонижении содержится в тендерной документации? Укажите требования, объёмы работ, сроки и технические решения."
- complexity: "medium"
- confidence: 0.95
```

---

## Структура stores.json

```json
[
  {
    "id": "stores/xxxxx",
    "name": "MYPRIORITY",
    "description": "Тендер на строительство ЖК MyPriority. Водопонижение, земляные работы.",
    "topics": ["водопонижение", "земляные работы", "фундамент"],
    "documents": [
      {
        "name": "ПОС.pdf",
        "file_id": "files/yyyyy",
        "source_url": "https://docs.google.com/document/d/...",
        "uploaded_at": "2024-01-15T10:30:00Z"
      }
    ],
    "sync_urls": ["https://drive.google.com/drive/folders/..."],
    "last_sync": "2024-01-15T10:30:00Z",
    "auto_sync_enabled": true
  }
]
```

---

## Переменные окружения (.env)

```env
# Обязательные
BOT_TOKEN=telegram_bot_token
GEMINI_API_KEY=gemini_api_key

# Опциональные
ADMIN_USER_ID=123456789
ALLOWED_USERS=123,456,789

# Модели (по умолчанию)
GEMINI_MODEL_FLASH=gemini-3-flash-preview
GEMINI_MODEL_PRO=gemini-3-pro-preview

# Память
MEMORY_MAX_MESSAGES=5
MEMORY_CLEANUP_DAYS=7

# Таймауты
QUERY_TIMEOUT=60

# Google Drive
GOOGLE_SERVICE_ACCOUNT_FILE=service_account.json
```

---

## Зависимости (requirements.txt)

```
python-telegram-bot>=20.0
google-genai>=1.0.0
python-dotenv>=1.0.0
google-auth>=2.0.0
google-api-python-client>=2.0.0
reportlab>=4.0.0
python-docx>=0.8.11
```

---

## Типичные сценарии использования

### Сценарий 1: Простой вопрос к store
```
User: Какой объём земляных работ?
→ QueryProcessor: complexity="simple", query_type="single"
→ Используется Flash
→ Ответ из выбранного store
```

### Сценарий 2: Поиск по всем stores
```
User: В каких тендерах есть водопонижение?
→ QueryProcessor: query_type="multistore"
→ Параллельный запрос ко всем stores (Flash)
→ Агрегированный ответ с цитатами
```

### Сценарий 3: Сравнение
```
User: /compare МайПриорити Дубровка земляные работы
→ compare_stores() с Pro моделью
→ Детальное сравнение двух тендеров
```

### Сценарий 4: Сложный аналитический запрос
```
User: Проанализируй требования к водопонижению и сравни с типовыми нормами
→ QueryProcessor: complexity="complex"
→ Используется Pro
→ Глубокий анализ
```

---

## Правила разработки (CLAUDE.md)

1. **Запрещён** локальный автоматический запуск приложений без разрешения
2. **Обязательно** делать коммит и пуш после каждого изменения

---

## Репозиторий

GitHub: `https://github.com/ihevodaporu872-hash/happy-jens.git`
Branch: `main`
